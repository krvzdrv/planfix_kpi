# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ Planfix KPI

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ KPI –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å Planfix CRM –∏ Telegram –±–æ—Ç–æ–º.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. üìä Core –º–æ–¥—É–ª–∏ (scripts/core/)
**–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ KPI —Ä–∞—Å—á–µ—Ç–æ–≤**

- **`config.py`** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (MANAGERS_KPI)
- **`kpi_engine.py`** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ KPI —Ä–∞—Å—á–µ—Ç–æ–≤
- **`kpi_data.py`** - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ KPI –¥–∞–Ω–Ω—ã—Ö
- **`kpi_report.py`** - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ KPI –æ—Ç—á–µ—Ç–æ–≤
- **`kpi_utils.py`** - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ)
- **`report_formatter.py`** - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –æ—Ç—á–µ—Ç–æ–≤

### 2. üîÑ Exporters (scripts/exporters/)
**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Planfix**

- **`planfix_export_clients.py`** - –≠–∫—Å–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- **`planfix_export_orders.py`** - –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤
- **`planfix_export_tasks.py`** - –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á

### 3. üìà Reports (scripts/reports/)
**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤**

- **`report_activity.py`** - –û—Ç—á–µ—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø–æ —á–∞—Å–∞–º)
- **`report_bonus.py`** - –û—Ç—á–µ—Ç –ø–æ –ø—Ä–µ–º–∏—è–º (PREMIA)
- **`report_income.py`** - –û—Ç—á–µ—Ç –ø–æ –¥–æ—Ö–æ–¥–∞–º (PRZYCHODY)
- **`report_kpi.py`** - –û—Å–Ω–æ–≤–Ω–æ–π KPI –æ—Ç—á–µ—Ç
- **`report_status.py`** - –û—Ç—á–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤ (WORONKA)

### 4. üõ†Ô∏è Utils (scripts/utils/)
**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã**

- **`planfix_utils.py`** - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Planfix API –∏ Supabase

### 5. ü§ñ Telegram Bot (bot/)
**API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞**

- **`api/telegram_webhook.py`** - Webhook –¥–ª—è –∫–æ–º–∞–Ω–¥ `/premia_current`, `/premia_previous`
- **`wsgi.py`** - WSGI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
graph TB
    %% –í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    Planfix[Planfix CRM<br/>API]
    Telegram[Telegram Bot<br/>API]
    Supabase[(Supabase<br/>PostgreSQL)]
    GitHub[GitHub<br/>Actions]
    Render[Render<br/>Hosting]

    %% Core –º–æ–¥—É–ª–∏
    subgraph "Core Logic"
        Config[config.py<br/>MANAGERS_KPI]
        Engine[kpi_engine.py<br/>KPI Engine]
        Data[kpi_data.py<br/>KPI Data]
        Utils[kpi_utils.py<br/>Math Utils]
        Formatter[report_formatter.py<br/>Formatter]
    end

    %% Exporters
    subgraph "Data Exporters"
        ClientExport[planfix_export_clients.py]
        OrderExport[planfix_export_orders.py]
        TaskExport[planfix_export_tasks.py]
    end

    %% Reports
    subgraph "Report Generators"
        ActivityReport[report_activity.py<br/>AKTYWNO≈öƒÜ]
        BonusReport[report_bonus.py<br/>PREMIA]
        IncomeReport[report_income.py<br/>PRZYCHODY]
        KpiReport[report_kpi.py<br/>KPI]
        StatusReport[report_status.py<br/>WORONKA]
    end

    %% Bot API
    subgraph "Telegram Bot"
        Webhook[telegram_webhook.py<br/>Webhook API]
    end

    %% –°–≤—è–∑–∏
    Planfix --> ClientExport
    Planfix --> OrderExport
    Planfix --> TaskExport
    
    ClientExport --> Supabase
    OrderExport --> Supabase
    TaskExport --> Supabase
    
    Supabase --> Engine
    Supabase --> Data
    Supabase --> ActivityReport
    Supabase --> BonusReport
    Supabase --> IncomeReport
    Supabase --> KpiReport
    Supabase --> StatusReport
    
    Config --> Engine
    Config --> Data
    Config --> ActivityReport
    Config --> KpiReport
    Config --> StatusReport
    
    Engine --> Formatter
    Data --> Engine
    Utils --> Engine
    Utils --> Data
    Utils --> IncomeReport
    Utils --> StatusReport
    
    Formatter --> BonusReport
    
    Telegram --> Webhook
    Webhook --> GitHub
    GitHub --> BonusReport
    
    ActivityReport --> Telegram
    BonusReport --> Telegram
    IncomeReport --> Telegram
    KpiReport --> Telegram
    StatusReport --> Telegram
    
    Webhook --> Render
```

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```
Planfix API ‚Üí Exporters ‚Üí Supabase ‚Üí Reports
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
```
Supabase ‚Üí Core Logic ‚Üí Report Generators ‚Üí Telegram
```

### 3. –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
```
Telegram ‚Üí Webhook ‚Üí GitHub Actions ‚Üí Report Generators ‚Üí Telegram
```

## KPI –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

### –ö–ª–∏–µ–Ω—Ç—ã (3 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
- **NWI** - Nowi (–Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã)
- **WTR** - W trakcie (–≤ —Ä–∞–±–æ—Ç–µ)
- **PSK** - Perspektywiczni (–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ)

### –ó–∞–¥–∞—á–∏ (11 –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)
- **WDM** - NawiƒÖzaƒá pierwszy kontakt
- **PRZ** - Przeprowadziƒá pierwszƒÖ rozmowƒô telefonicznƒÖ
- **KZI** - Klient jest zainteresowany
- **ZKL** - Zadzwoniƒá do klienta
- **SPT** - Przeprowadziƒá spotkanie
- **MAT** - Wys≈Çaƒá materia≈Çy
- **TPY** - Odpowiedzieƒá na pytanie techniczne
- **MSP** - Zapisaƒá na media spo≈Çeczno≈õciowe
- **NOW** - Opowiedzieƒá o nowo≈õciach
- **OPI** - Zebraƒá opinie
- **WRK** - Przywr√≥ciƒá klienta
- **KNT** - Tworzyƒá kontent
- **TTL** - Total (–æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –∑–∞–¥–∞—á)

### –ó–∞–∫–∞–∑—ã (3 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
- **OFW** - –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- **ZAM** - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
- **PRC** - –í—ã—Ä—É—á–∫–∞ (–ø—Ä–∏–±—ã–ª—å)

## –¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤

### 1. Activity Report (AKTYWNO≈öƒÜ)
- **–§–æ—Ä–º–∞—Ç**: `AKTYWNO≈öƒÜ_DD.MM.YYYY`
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Å–∞–º (9:00-16:59), –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—ã

### 2. KPI Report
- **–§–æ—Ä–º–∞—Ç**: `KPI_DD.MM.YYYY` (–¥–Ω–µ–≤–Ω–æ–π), `KPI_MM.YYYY` (–º–µ—Å—è—á–Ω—ã–π)
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00 (–æ–±–∞ –æ—Ç—á–µ—Ç–∞)
- **–†–∞–∑–¥–µ–ª—ã**: –ö–ª–∏–µ–Ω—Ç—ã, –ó–∞–¥–∞—á–∏, –ó–∞–∫–∞–∑—ã

### 3. Bonus Report (PREMIA)
- **–§–æ—Ä–º–∞—Ç**: `PREMIA_MM.YYYY`
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00 + –ø–æ –∫–æ–º–∞–Ω–¥–µ –±–æ—Ç–∞
- **–ö–æ–º–∞–Ω–¥—ã**: `/premia_current`, `/premia_previous`
- **–†–∞—Å—á–µ—Ç**: SUM ‚Üí FND ‚Üí PRK + PRW ‚Üí TOT

### 4. Income Report (PRZYCHODY)
- **–§–æ—Ä–º–∞—Ç**: `PRZYCHODY_MM.YYYY`
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00
- **–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏**: Fakt (‚ñà), D≈Çug (‚ñí), Brak (‚ñë), Plan

### 5. Status Report (WORONKA)
- **–§–æ—Ä–º–∞—Ç**: `WORONKA_DD.MM.YYYY`
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00
- **–°—Ç–∞—Ç—É—Å—ã**: 9 —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –¥–∏–Ω–∞–º–∏–∫–æ–π ‚ñ≤‚ñº

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

```python
MANAGERS_KPI = [
    {
        'planfix_user_name': 'Kozik Andrzej',
        'planfix_user_id': 945243
    },
    {
        'planfix_user_name': 'Stukalo Nazarii', 
        'planfix_user_id': 945245
    }
]
```

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend**: Python 3.10+
- **Web Framework**: Flask
- **Database**: PostgreSQL (Supabase)
- **API Integration**: Planfix XML API, Telegram Bot API
- **Deployment**: Render
- **CI/CD**: GitHub Actions
- **Dependencies**: psycopg2, requests, python-dotenv

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã

**–ù–ï –£–î–ê–õ–Ø–¢–¨:**
- `scripts/core/` - –≤—Å—è –ø–∞–ø–∫–∞ —Å KPI –ª–æ–≥–∏–∫–æ–π
- `scripts/core/config.py` - —Å–æ–¥–µ—Ä–∂–∏—Ç MANAGERS_KPI
- `scripts/report_*.py` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
- `scripts/planfix_export_*.py` - —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
- `scripts/planfix_utils.py` - —É—Ç–∏–ª–∏—Ç—ã
- `requirements.txt` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –í—Å–µ workflow —Ñ–∞–π–ª—ã –≤ `.github/workflows/`

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ KPI** - –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è min(—Ñ–∞–∫—Ç, –ø–ª–∞–Ω)
3. **–ì–∏–±–∫–∏–µ –ø–µ—Ä–∏–æ–¥—ã** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–Ω–µ–≤–Ω—ã—Ö, –º–µ—Å—è—á–Ω—ã—Ö, –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
4. **–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤** - –¥–ª—è STL/NAK –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–µ–¥–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –≤—Å–µ –æ—Ç—á–µ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
6. **Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ø—Ä–µ–º–∏—è–º
